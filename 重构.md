# 盈利型校园综合服务平台架构与实施规划书

## 1. 业务定位与商业模式闭环

### 1.1 核心业务模块定义

本平台旨在整合校园碎片化需求，通过“高频带低频”策略，构建以**校园贴吧**为流量入口，**跑腿服务**为现金牛，**二手交易**与**兼职信息**为长尾增值的商业生态。

| 模块名称 | 核心功能 | 用户价值 | 盈利模式 |
| --- | --- | --- | --- |
| **校园贴吧 (Core)** | 匿名/实名发帖、话题圈子、表白墙、官方通知 | 信息获取、情感宣泄、社交连接 | 广告位（Banner/Feed流）、置顶帖收费、会员标识 |
| **跑腿服务 (Cash)** | 代取快递、代买餐食、帮送文件、排队占座 | 节省时间、懒人经济 | 每单抽佣 (10%-20%)、加急费、骑士会员费 |
| **二手交易 (Long-tail)** | 闲置物品发布、拍卖、信用评分、线下自提 | 资源循环、低价淘宝 | 交易手续费（可选）、商品置顶费、验货服务费 |
| **兼职信息 (B2B)** | 商家发布兼职、学生投递简历、薪资结算 | 勤工俭学、商家灵活用工 | 商家发布费、认证商家年费、招聘置顶 |

### 1.2 用户行为建模与需求分析

为了实现精准的产品设计，我们对三大核心用户群体进行行为建模：

#### A. 学生用户 (Student)

* **行为特征**: 价格敏感但冲动消费、活跃时间集中（课间/晚间）、社交需求强、乐于分享但注重隐私。
* **核心痛点**: 懒（不想下楼）、穷（想搞钱/省钱）、闲（刷帖吃瓜）。
* **平台对策**:
* **UI/UX**: 引入 `jingwenWall` 的流式布局，增强沉浸感。
* **风控**: 必须引入学号/教务系统认证，建立“学生信用分”。
* **激励**: 跑腿接单可获得积分，积分可兑换二手商品优惠券。



#### B. 商家/B端用户 (Merchant)

* **行为特征**: 追求转化率、操作需极简、愿意为流量付费。
* **核心痛点**: 校园推广渠道有限、招人难管理难、外卖平台抽成高。
* **平台对策**:
* 提供独立的“商家工作台”小程序端。
* 兼职发布系统支持一键群发与简历筛选。



#### C. 管理员/运营者 (Admin)

* **行为特征**: 关注数据大屏、风险控制（言论/资金）、财务对账。
* **核心痛点**: 内容审核压力大、资金流向不透明、系统维护成本高。
* **平台对策**:
* 复用 `jingwenhub` 强大的 RBAC 权限管理。
* 集成自动内容过滤 API（阿里云/微信）。



---

## 2. 技术融合与架构蓝图

### 2.1 技术选型策略

采用 **扼杀者模式 (Strangler Fig Pattern)**，以 `jingwenhub` 为基座，逐步吞并并重构 `jingwenWall` 的业务逻辑。

* **后端基座**: `jingwenhub` (Spring Boot + RuoYi-Vue-Plus)。
* *理由*: 具备完善的代码生成、MyBatis-Plus、Sa-Token 鉴权、系统监控，适合做底座。


* **前端重构**: `uni-app` (Vue 3 + Vite + uView-Plus)。
* *理由*: `jingwenWall` 原有前端较旧，需升级至 Vue 3 以获得更好的性能和开发体验，支持多端发布（微信小程序为主）。



### 2.2 系统架构图

```mermaid
graph TD
    User[用户端 (Uni-app/Vue3)] --> |HTTPS/WSS| Gateway[API 网关 (Nginx)]
    Gateway --> |Auth & Rate Limit| Backend[后端服务 (Spring Boot)]
    
    subgraph "后端核心模块 (jingwenhub Base)"
        Backend --> Sys[系统管理 (SysUser, Menu)]
        Backend --> Auth[认证授权 (Sa-Token)]
        Backend --> Gen[代码生成]
    end
    
    subgraph "业务模块 (重构自 jingwenWall)"
        Backend --> Forum[贴吧模块]
        Backend --> Errand[跑腿模块]
        Backend --> Market[二手模块]
        Backend --> Job[兼职模块]
    end
    
    subgraph "基础设施"
        Backend --> MySQL[(MySQL 8.0)]
        Backend --> Redis[(Redis 缓存/队列)]
        Backend --> MQ[RabbitMQ (削峰填谷)]
        Backend --> OSS[对象存储 (MinIO/Aliyun)]
    end
    
    Backend --> Pay[微信支付 V3]

```

---

## 3. 数据库建模与核心 Schema

我们将复用 `jingwenhub` 的 `sys_user` 作为基础账户，扩展 `bus_student` 表，并新建业务表。

### 3.1 用户体系融合

在 `campus-common` 模块中扩展用户实体。

```sql
-- 学生信息扩展表 (与 sys_user 1:1 关联)
CREATE TABLE `bus_student` (
  `student_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `user_id` bigint(20) NOT NULL COMMENT '关联sys_user ID',
  `student_no` varchar(32) DEFAULT NULL COMMENT '学号',
  `real_name` varchar(32) DEFAULT NULL COMMENT '真实姓名',
  `college` varchar(64) DEFAULT NULL COMMENT '学院',
  `credit_score` int(11) DEFAULT 100 COMMENT '信用分',
  `balance` decimal(10,2) DEFAULT 0.00 COMMENT '钱包余额',
  `is_runner` tinyint(1) DEFAULT 0 COMMENT '是否认证骑手',
  PRIMARY KEY (`student_id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB COMMENT='学生信息表';

```

### 3.2 跑腿订单设计 (核心盈利)

重点解决并发抢单与状态流转。

```sql
CREATE TABLE `bus_errand_order` (
  `order_id` bigint(20) NOT NULL COMMENT '订单ID',
  `order_no` varchar(64) NOT NULL COMMENT '订单号',
  `publisher_id` bigint(20) NOT NULL COMMENT '发布者ID',
  `runner_id` bigint(20) DEFAULT NULL COMMENT '接单骑手ID',
  `type` tinyint(4) NOT NULL COMMENT '类型: 0-取件 1-寄件 2-排队 3-其它',
  `pickup_addr` varchar(255) DEFAULT NULL COMMENT '取件地址',
  `delivery_addr` varchar(255) NOT NULL COMMENT '送达地址',
  `goods_desc` varchar(255) DEFAULT NULL COMMENT '物品描述',
  `total_fee` decimal(10,2) NOT NULL COMMENT '总费用',
  `runner_fee` decimal(10,2) NOT NULL COMMENT '骑手佣金',
  `platform_fee` decimal(10,2) NOT NULL COMMENT '平台抽成',
  `status` tinyint(4) DEFAULT 0 COMMENT '状态: 0-待接单 1-配送中 2-待确认 3-已完成 4-已取消',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `version` int(11) DEFAULT 0 COMMENT '乐观锁版本号',
  PRIMARY KEY (`order_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB COMMENT='跑腿订单表';

```

### 3.3 贴吧内容表 (迁移自 jingwenWall)

将 `jingwenWall` 中的 `Topic` 实体迁移并优化。

```sql
CREATE TABLE `bus_forum_post` (
  `post_id` bigint(20) NOT NULL COMMENT '帖子ID',
  `user_id` bigint(20) NOT NULL COMMENT '发布者',
  `category_id` bigint(20) NOT NULL COMMENT '板块ID',
  `content` text COMMENT '文本内容',
  `images` json DEFAULT NULL COMMENT '图片列表(JSON)',
  `is_anonymous` tinyint(1) DEFAULT 0 COMMENT '是否匿名',
  `view_count` int(11) DEFAULT 0 COMMENT '浏览量',
  `like_count` int(11) DEFAULT 0 COMMENT '点赞数',
  `status` tinyint(4) DEFAULT 1 COMMENT '状态: 0-审核中 1-正常 2-拒绝',
  PRIMARY KEY (`post_id`)
) ENGINE=InnoDB COMMENT='校园贴吧帖子表';

```

---

## 4. 后端接口规范与开发

基于 `jingwenhub` 的 `campus-modular` 模块进行开发。

### 4.1 接口设计原则

* **RESTful 风格**: `GET /api/v1/errands` (列表), `POST /api/v1/errands` (下单).
* **统一响应**: 使用 `R<T>` 类封装返回结果。
* **鉴权**: 使用 `@SaCheckLogin` 确保用户已登录，`@SaCheckRole("student")` 确保身份。

### 4.2 核心业务逻辑伪代码 (Java)

**跑腿抢单 (解决并发问题):**

```java
// ErrandService.java
@Transactional
public void acceptOrder(Long orderId, Long runnerId) {
    // 1. Redis 分布式锁，防止多人同时抢同一单
    String lockKey = "lock:errand:" + orderId;
    if (!redisUtils.lock(lockKey)) {
        throw new BusinessException("手慢了，单子被抢走了！");
    }
    
    try {
        // 2. 查询订单
        ErrandOrder order = errandMapper.selectById(orderId);
        if (order.getStatus() != OrderStatus.WAITING) {
            throw new BusinessException("订单状态已改变");
        }
        
        // 3. 乐观锁更新状态
        order.setStatus(OrderStatus.DELIVERING);
        order.setRunnerId(runnerId);
        // update bus_errand_order set status=1, runner_id=? where order_id=? and version=?
        int rows = errandMapper.updateById(order); 
        
        if (rows == 0) {
            throw new BusinessException("抢单失败，请重试");
        }
        
        // 4. 发送消息通知发布者 (WebSocket / 微信订阅消息)
        messageService.sendOrderAccepted(order.getPublisherId(), order);
        
    } finally {
        redisUtils.unlock(lockKey);
    }
}

```

---

## 5. 前端工程化与 UI 重构

### 5.1 架构升级

放弃 `jingwenWall` 原有的 Vue 2 写法，使用 **Vue 3 (Composition API) + TypeScript** 重写。

* **框架**: Uni-app (Vite版)
* **UI库**: uView-Plus (专为 Uni-app Vue3 设计)
* **状态管理**: Pinia (替代 Vuex)
* **网络请求**: 封装 `luch-request`，增加拦截器处理 JWT Token。

### 5.2 目录结构规划

```text
/src
  /api          // 统一管理后端接口 (User.ts, Errand.ts)
  /components   // 公共组件 (Navbar, Tabbar, WaterfallFlow)
  /pages
    /home       // 首页 (贴吧 Feed 流)
    /errand     // 跑腿大厅 (地图模式/列表模式)
    /market     // 二手集市
    /profile    // 个人中心 (订单管理、认证)
  /stores       // Pinia 状态 (UserStore, ConfigStore)
  /utils        // 工具类 (Payment, TimeFormat)

```

### 5.3 关键交互设计

* **贴吧**: 实现类似朋友圈的图片九宫格预览，长列表虚拟滚动（Virtual Scroll）以优化性能。
* **跑腿**: 引入地图组件，显示“待接单”的位置分布（基于 Redis GEO）。

---

## 6. 支付系统与风控机制

### 6.1 微信支付 V3 集成

为了合规，必须使用企业资质申请微信支付。

1. **预下单 (Backend)**: 调用 `WechatPayHttpClient` 生成 `prepay_id`。
2. **签名 (Backend)**: 使用私钥对参数签名，返回给前端。
3. **调起支付 (Frontend)**: `uni.requestPayment`。
4. **回调处理 (Backend)**: 校验微信回调签名，更新订单状态，写入资金流水表。

### 6.2 资金流转与风控

* **担保交易**:
* 用户支付 -> 资金进入平台商户号（冻结） -> 订单完成 -> 资金解冻划入骑手余额 -> 骑手提现。


* **提现限制**:
* T+1 到账，单日提现上限 500 元，需实名认证一致。


* **反作弊**:
* 同一设备 ID 频繁切换账号封禁。
* 短时间内发布大量重复内容的 IP 封禁。



---

## 7. 实施路线图 (Roadmap)

### 阶段一：基础整合 (Weeks 1-3)

* **任务**: 搭建 `jingwenhub` 后端环境，清理多余模块。
* **任务**: 建立新的数据库 Schema，完成 `SysUser` 到 `Student` 的映射。
* **交付**: 后端 Swagger 文档可用，基础登录注册（含学号认证）跑通。

### 阶段二：核心业务开发 (Weeks 4-6)

* **任务**: 移植 `jingwenWall` 的帖子与评论逻辑到 Spring Boot。
* **任务**: 开发跑腿订单系统（发单、接单、结算）。
* **交付**: 跑腿与贴吧模块后端 API 完成 100%。

### 阶段三：前端重构 (Weeks 7-10)

* **任务**: 使用 Uni-app + Vue 3 搭建脚手架。
* **任务**: 开发“首页”、“跑腿大厅”、“个人中心”页面。
* **交付**: 小程序前端可运行，UI 交互流畅。

### 阶段四：支付与联调 (Weeks 11-12)

* **任务**: 集成微信支付，完成支付回调逻辑。
* **任务**: 前后端联调，修复 BUG。
* **交付**: 完整的交易闭环。

### 阶段五：部署与运维

* **CI/CD**:
* GitHub Actions 监听 `master` 分支 -> Build Docker Image -> Push to Aliyun Registry -> SSH remote command -> `docker-compose up -d`.


* **监控**:
* 部署 Spring Boot Admin 监控应用状态。
* 使用 ELK Stack (或轻量级 Loki) 收集日志，便于排查线上支付问题。



---

本方案充分利用了开源项目的现有资产，通过合理的架构重组与商业化改造，能够在降低开发成本的同时，确保平台的高可用性与盈利能力。