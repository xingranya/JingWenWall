<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oddfar.campus.business.market.mapper.MarketItemMapper">

    <resultMap id="ItemVoResultMap" type="com.oddfar.campus.business.market.domain.vo.MarketItemVO">
        <id property="itemId" column="item_id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="categoryId" column="category_id" jdbcType="BIGINT"/>
        <result property="categoryName" column="category_name" jdbcType="VARCHAR"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="description" column="description" jdbcType="LONGVARCHAR"/>
        <result property="images" column="images" jdbcType="VARCHAR"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="price" column="price" jdbcType="DECIMAL"/>
        <result property="originalPrice" column="original_price" jdbcType="DECIMAL"/>
        <result property="conditionLevel" column="condition_level" jdbcType="INTEGER"/>
        <result property="tradeMethod" column="trade_method" jdbcType="INTEGER"/>
        <result property="tradeLocation" column="trade_location" jdbcType="VARCHAR"/>
        <result property="viewCount" column="view_count" jdbcType="INTEGER"/>
        <result property="collectCount" column="collect_count" jdbcType="INTEGER"/>
        <result property="status" column="status" jdbcType="INTEGER"/>
        <result property="nickName" column="nick_name" jdbcType="VARCHAR"/>
        <result property="avatar" column="avatar" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="selectItemVo">
        SELECT i.item_id, i.user_id, i.category_id, i.title, i.description, i.images,
               i.price, i.original_price, i.condition_level, i.trade_method, i.trade_location,
               i.view_count, i.collect_count, i.status, i.create_time, i.update_time,
               u.nick_name, u.avatar,
               c.category_name
        FROM bus_market_item i
        LEFT JOIN sys_user u ON i.user_id = u.user_id
        LEFT JOIN bus_category c ON i.category_id = c.category_id
        WHERE i.del_flag = 0
    </sql>

    <!-- 查询商品列表 -->
    <select id="selectItemList" resultMap="ItemVoResultMap">
        <include refid="selectItemVo"/>
        AND i.status = 1
        <if test="categoryId != null">
            AND i.category_id = #{categoryId}
        </if>
        ORDER BY i.create_time DESC
    </select>

    <!-- 查询商品详情 -->
    <select id="selectItemDetail" resultMap="ItemVoResultMap">
        <include refid="selectItemVo"/>
        AND i.item_id = #{itemId}
        LIMIT 1
    </select>

    <!-- 查询用户发布的商品 -->
    <select id="selectItemsByUserId" resultMap="ItemVoResultMap">
        <include refid="selectItemVo"/>
        AND i.user_id = #{userId}
        ORDER BY i.create_time DESC
    </select>

    <!-- 搜索商品 -->
    <select id="searchItems" resultMap="ItemVoResultMap">
        <include refid="selectItemVo"/>
        AND i.status = 1
        AND (i.title LIKE CONCAT('%', #{keyword}, '%') OR i.description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY i.create_time DESC
    </select>

    <!-- 更新浏览次数 -->
    <update id="updateViewCount">
        UPDATE bus_market_item 
        SET view_count = view_count + 1
        WHERE item_id = #{itemId}
    </update>

    <!-- 管理后台-查询商品列表 -->
    <select id="selectAdminItemList" resultMap="ItemVoResultMap">
        <include refid="selectItemVo"/>
        <if test="status != null">
            AND i.status = #{status}
        </if>
        <if test="categoryId != null">
            AND i.category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (i.title LIKE CONCAT('%', #{keyword}, '%') OR i.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY i.create_time DESC
    </select>

    <!-- 统计总商品数 -->
    <select id="countTotal" resultType="java.lang.Long">
        SELECT COUNT(*) FROM bus_market_item WHERE del_flag = 0
    </select>

    <!-- 按状态统计商品数 -->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*) FROM bus_market_item WHERE del_flag = 0 AND status = #{status}
    </select>

</mapper>
